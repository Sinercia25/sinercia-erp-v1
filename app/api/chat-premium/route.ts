// üì¶ CONFIGURACI√ìN GENERAL Y CONEXIONES
import { NextRequest, NextResponse } from 'next/server'
import { Pool as PgPool } from 'pg'
import parseDbUrl from 'parse-database-url'
import { OpenAI } from 'openai'
import { systemPrompt, examples } from '@/lib/prompt'
import { ConversationMemoryManager } from '@/lib/conversation-memory'

const {
  DWH_URL,
    DATABASE_URL,
      OPENAI_API_KEY,
        TEMPERATURE = '0.8',
          TOP_P = '0.9'
          } = process.env

          if (!DWH_URL || !DATABASE_URL || !OPENAI_API_KEY) {
            throw new Error('üö® Faltan variables de entorno: DWH_URL, DATABASE_URL o OPENAI_API_KEY')
            }

            const dwhConfig = parseDbUrl(DWH_URL)
            const dwhPool = new PgPool({
              host: dwhConfig.host,
                port: dwhConfig.port,
                  user: dwhConfig.user,
                    password: dwhConfig.password,
                      database: dwhConfig.database,
                        ssl: { rejectUnauthorized: false },
                          max: 10,
                            idleTimeoutMillis: 30000
                            })
                            // ü§ñ INSTANCIA DE OPENAI
                            const openai = new OpenAI({
                              apiKey: OPENAI_API_KEY
                              })

                              // üîç Funci√≥n auxiliar: obtener nombre e industria desde tabla companies del DWH
                              async function obtenerContextoEmpresa(empresa_id: string) {
                                const { rows } = await dwhPool.query<{
                                    nombre: string;
                                        industria: string;
                                          }>(`
                                              SELECT nombre, industria
                                                  FROM empresas
                                                      WHERE id = $1
                                                          LIMIT 1
                                                            `, [empresa_id]);

                                                              if (rows.length === 0) {
                                                                  throw new Error(`Empresa no encontrada: ${empresa_id}`);
                                                                    }

                                                                      return {
                                                                          nombre: rows[0].nombre,
                                                                              sector: rows[0].industria 
                                                                                };
                                                                                }


                                                                                // üî¢ CONSULTA RESUMEN MENSUAL desde el DWH
                                                                                async function consultarResumenMensual(empresa_id: string, mes: number, a√±o: number) {
                                                                                  const ventasSQL = `
                                                                                      SELECT SUM(total::numeric) AS total_ventas
                                                                                          FROM facturas
                                                                                              WHERE empresa_id = $1
                                                                                                    AND fecha_emision >= DATE '${a√±o}-${mes}-01'
                                                                                                          AND fecha_emision < DATE '${a√±o}-${mes}-01' + INTERVAL '1 month'
                                                                                                            `;

                                                                                                              const transaccionesSQL = `
                                                                                                                  SELECT
                                                                                                                        SUM(CASE WHEN tipo = 'INGRESO' THEN importe ELSE 0 END) AS total_ingresos,
                                                                                                                              SUM(CASE WHEN tipo = 'EGRESO' THEN importe ELSE 0 END) AS total_egresos,
                                                                                                                                    COUNT(*) AS total_transacciones,
                                                                                                                                          SUM(importe) AS total_importe_transacciones
                                                                                                                                              FROM transacciones
                                                                                                                                                  WHERE empresa_id = $1
                                                                                                                                                        AND fecha >= DATE '${a√±o}-${mes}-01'
                                                                                                                                                              AND fecha <  DATE '${a√±o}-${mes}-01' + INTERVAL '1 month'
                                                                                                                                                                `;

                                                                                                                                                                  const ventasResult = await dwhPool.query(ventasSQL, [empresa_id])
                                                                                                                                                                    const transaccionesResult = await dwhPool.query(transaccionesSQL, [empresa_id])

                                                                                                                                                                      const total_ventas = parseFloat(ventasResult.rows[0]?.total_ventas || '0')
                                                                                                                                                                        console.log('‚úÖ total_ventas procesado:', total_ventas)

                                                                                                                                                                          const fila = transaccionesResult.rows[0] || {
                                                                                                                                                                              total_transacciones: 0,
                                                                                                                                                                                  total_importe_transacciones: 0,
                                                                                                                                                                                      total_ingresos: 0,
                                                                                                                                                                                          total_egresos: 0
                                                                                                                                                                                            }

                                                                                                                                                                                              return {
                                                                                                                                                                                                  mes,
                                                                                                                                                                                                      anio: a√±o,
                                                                                                                                                                                                          total_ventas,
                                                                                                                                                                                                              total_ingresos: parseFloat(fila.total_ingresos ?? '0'),
                                                                                                                                                                                                                  total_egresos: parseFloat(fila.total_egresos ?? '0'),
                                                                                                                                                                                                                      total_transacciones: parseInt(fila.total_transacciones ?? '0'),
                                                                                                                                                                                                                          total_importe_transacciones: parseFloat(fila.total_importe_transacciones ?? '0'),
                                                                                                                                                                                                                              resumen: `Durante el mes de ${new Date(a√±o, mes - 1).toLocaleString('es-AR', { month: 'long' }).toUpperCase()} ${a√±o}, se registraron ventas por $${(total_ventas / 1e6).toFixed(2)}M, ingresos por $${(fila.total_ingresos / 1e6).toFixed(2)}M y egresos por $${(fila.total_egresos / 1e6).toFixed(2)}M.`
                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                }


                                                                                                                                                                                                                                // üß† INTERPRETACI√ìN TEMPORAL EXTENDIDA v1.3 - incluye "desde...hasta" y mejora detecci√≥n de nombres de meses como "julio"
                                                                                                                                                                                                                                export type PeriodoDetectado = {
                                                                                                                                                                                                                                  tipo: 'dia' | 'semana' | 'mes' | 'trimestre' | 'a√±o' | 'decada' | 'rango',
                                                                                                                                                                                                                                    inicio: Date,
                                                                                                                                                                                                                                      fin: Date,
                                                                                                                                                                                                                                        descripcion: string
                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                        export function interpretarTiempoExtendido(texto: string): PeriodoDetectado | null {
                                                                                                                                                                                                                                          texto = texto.toLowerCase()
                                                                                                                                                                                                                                            const ahora = new Date()
                                                                                                                                                                                                                                              const a√±oActual = ahora.getFullYear()
                                                                                                                                                                                                                                                const mesActual = ahora.getMonth()
                                                                                                                                                                                                                                                  const diaActual = ahora.getDate()

                                                                                                                                                                                                                                                    const meses = [
                                                                                                                                                                                                                                                        'enero','febrero','marzo','abril','mayo','junio',
                                                                                                                                                                                                                                                            'julio','agosto','septiembre','octubre','noviembre','diciembre'
                                                                                                                                                                                                                                                              ]

                                                                                                                                                                                                                                                                // üóìÔ∏è NOMBRE DEL MES (ej: "julio")
                                                                                                                                                                                                                                                                  for (let i = 0; i < meses.length; i++) {
                                                                                                                                                                                                                                                                      if (texto.includes(meses[i])) {
                                                                                                                                                                                                                                                                            const inicio = new Date(a√±oActual, i, 1)
                                                                                                                                                                                                                                                                                  const fin = new Date(a√±oActual, i + 1, 1)
                                                                                                                                                                                                                                                                                        return {
                                                                                                                                                                                                                                                                                                tipo: 'mes',
                                                                                                                                                                                                                                                                                                        inicio,
                                                                                                                                                                                                                                                                                                                fin,
                                                                                                                                                                                                                                                                                                                        descripcion: `el mes de ${meses[i].toUpperCase()} ${a√±oActual}`
                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                      // ‚ú≥Ô∏è DETECCI√ìN DE RANGO: "desde X hasta Y"
                                                                                                                                                                                                                                                                                                                                        const matchDesdeHasta = texto.match(/desde\s+(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})\s+(hasta|a)\s+(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/)
                                                                                                                                                                                                                                                                                                                                          if (matchDesdeHasta) {
                                                                                                                                                                                                                                                                                                                                              const [d1, d2] = [matchDesdeHasta[1], matchDesdeHasta[3]]
                                                                                                                                                                                                                                                                                                                                                  const inicio = new Date(d1.replace(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/, '$3-$2-$1'))
                                                                                                                                                                                                                                                                                                                                                      const fin = new Date(d2.replace(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/, '$3-$2-$1'))
                                                                                                                                                                                                                                                                                                                                                          fin.setDate(fin.getDate() + 1)
                                                                                                                                                                                                                                                                                                                                                              return { tipo: 'rango', inicio, fin, descripcion: `desde el ${d1} hasta el ${d2}` }
                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                  // üü¢ AYER, HOY, MA√ëANA
                                                                                                                                                                                                                                                                                                                                                                    if (texto.includes('ayer')) {
                                                                                                                                                                                                                                                                                                                                                                        const inicio = new Date(a√±oActual, mesActual, diaActual - 1)
                                                                                                                                                                                                                                                                                                                                                                            const fin = new Date(a√±oActual, mesActual, diaActual)
                                                                                                                                                                                                                                                                                                                                                                                return { tipo: 'dia', inicio, fin, descripcion: 'ayer' }
                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                    if (texto.includes('hoy')) {
                                                                                                                                                                                                                                                                                                                                                                                        const inicio = new Date(a√±oActual, mesActual, diaActual)
                                                                                                                                                                                                                                                                                                                                                                                            const fin = new Date(inicio)
                                                                                                                                                                                                                                                                                                                                                                                                fin.setDate(fin.getDate() + 1)
                                                                                                                                                                                                                                                                                                                                                                                                    return { tipo: 'dia', inicio, fin, descripcion: 'hoy' }
                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                        if (texto.includes('ma√±ana')) {
                                                                                                                                                                                                                                                                                                                                                                                                            const inicio = new Date(a√±oActual, mesActual, diaActual + 1)
                                                                                                                                                                                                                                                                                                                                                                                                                const fin = new Date(inicio)
                                                                                                                                                                                                                                                                                                                                                                                                                    fin.setDate(fin.getDate() + 1)
                                                                                                                                                                                                                                                                                                                                                                                                                        return { tipo: 'dia', inicio, fin, descripcion: 'ma√±ana' }
                                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                                            // üìÖ MES ACTUAL y MES PASADO
                                                                                                                                                                                                                                                                                                                                                                                                                              if (texto.includes('este mes')) {
                                                                                                                                                                                                                                                                                                                                                                                                                                  const inicio = new Date(a√±oActual, mesActual, 1)
                                                                                                                                                                                                                                                                                                                                                                                                                                      const fin = new Date(a√±oActual, mesActual + 1, 1)
                                                                                                                                                                                                                                                                                                                                                                                                                                          return { tipo: 'mes', inicio, fin, descripcion: `este mes (${inicio.toLocaleString('es-AR', { month: 'long' })} ${a√±oActual})` }
                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                              if (texto.includes('mes pasado') || texto.includes('mes anterior')) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                  const m = mesActual === 0 ? 11 : mesActual - 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                      const y = mesActual === 0 ? a√±oActual - 1 : a√±oActual
                                                                                                                                                                                                                                                                                                                                                                                                                                                          const inicio = new Date(y, m, 1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                              const fin = new Date(y, m + 1, 1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  return { tipo: 'mes', inicio, fin, descripcion: `el mes de ${meses[m].toUpperCase()} ${y}` }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // üîÅ Hace X a√±os o meses
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const matchAnios = texto.match(/hace\s+(\d+)\s+a[n√±]os?/) 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (matchAnios) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const n = parseInt(matchAnios[1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const y = a√±oActual - n
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const inicio = new Date(y, 0, 1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const fin = new Date(y + 1, 0, 1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return { tipo: 'a√±o', inicio, fin, descripcion: `el a√±o ${y}` }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const matchMeses = texto.match(/hace\s+(\d+)\s+meses?/) 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (matchMeses) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const n = parseInt(matchMeses[1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const d = new Date(a√±oActual, mesActual, 1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                d.setMonth(d.getMonth() - n)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const inicio = new Date(d.getFullYear(), d.getMonth(), 1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const fin = new Date(inicio.getFullYear(), inicio.getMonth() + 1, 1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return { tipo: 'mes', inicio, fin, descripcion: `hace ${n} meses (${meses[inicio.getMonth()].toUpperCase()} ${inicio.getFullYear()})` }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // üìÜ A√±o exacto y frases tipo "el a√±o pasado" ‚Äî se ajusta al mes actual del a√±o pasado si no se especifica mes"el a√±o pasado", "y el a√±o 2020"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const matchAnioDirecto = texto.match(/(en|del|a[n√±]o|y el a[n√±]o|para el a[n√±]o)\s*(\d{4})/)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (matchAnioDirecto) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const y = parseInt(matchAnioDirecto[2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return { tipo: 'a√±o', inicio: new Date(y, 0, 1), fin: new Date(y + 1, 0, 1), descripcion: `el a√±o ${y}` }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (texto.includes('el a√±o pasado') || texto.includes('a√±o anterior') || texto.includes('y el a√±o pasado')) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const y = a√±oActual - 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const inicio = new Date(y, mesActual, 1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const fin = new Date(y, mesActual + 1, 1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return { tipo: 'mes', inicio, fin, descripcion: `el mes de ${meses[mesActual].toUpperCase()} ${y}` }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // üóìÔ∏è D√©cada
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const matchDecada = texto.match(/d[√©e]cada\s+(del\s+)?(\d{2})/)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (matchDecada) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const dec = parseInt(matchDecada[2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const base = dec < 30 ? 2000 : 1900
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const y = base + dec
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              tipo: 'decada',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    inicio: new Date(y, 0, 1),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          fin: new Date(y + 10, 0, 1),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                descripcion: `la d√©cada del ${dec}0`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // üìâ √öltimos N a√±os
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const matchUltimos = texto.match(/√∫ltimos?\s+(\d+)\s+a[n√±]os?/) 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (matchUltimos) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const n = parseInt(matchUltimos[1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const inicio = new Date(a√±oActual - n, 0, 1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const fin = new Date(a√±oActual + 1, 0, 1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  tipo: 'rango',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        inicio,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              fin,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    descripcion: `los √∫ltimos ${n} a√±os`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return null
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // ‚úÖ POST Handler: Procesamiento completo del mensaje del usuario
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            export async function POST(req: NextRequest) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const { message, empresa_id, userId = 'default', temperature: ovTemp, top_p: ovTopP } = await req.json();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (!message) return NextResponse.json({ error: 'Mensaje requerido' }, { status: 400 });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if (!empresa_id) return NextResponse.json({ error: 'Empresa requerida' }, { status: 400 });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const periodo = interpretarTiempoExtendido(message);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if (!periodo) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return NextResponse.json({ error: 'No se pudo interpretar el periodo solicitado' }, { status: 400 });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const mes = periodo.inicio.getMonth() + 1;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const anio = periodo.inicio.getFullYear();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const resumen = await consultarResumenMensual(empresa_id, mes, anio);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const { nombre, sector } = await obtenerContextoEmpresa(empresa_id);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const categoria = ConversationMemoryManager.detectContext(message, userId);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const fewShotMessages = examples.flatMap(ex => [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      { role: 'user', content: ex.user },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            { role: 'assistant', content: ex.assistant }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ]);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const promptIA = `
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    Datos de la empresa ${nombre} (${sector}):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    - Total transacciones: ${resumen.total_transacciones}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    - Importe transacciones: ${resumen.total_importe_transacciones}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    - Total ventas: ${resumen.total_ventas}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    - Total ingresos: ${resumen.total_ingresos}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    - Total egresos: ${resumen.total_egresos}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    Pregunta: ${message}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    Responde SOLO en JSON:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    { "recomendaciones": ["rec1", "rec2"] }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    `.trim();

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const completion = await openai.chat.completions.create({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              model: 'gpt-4o-mini',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    messages: [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            { role: 'system', content: systemPrompt },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ...fewShotMessages,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            { role: 'user', content: promptIA }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        max_tokens: 200,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              temperature: ovTemp != null ? Number(ovTemp) : Number(TEMPERATURE),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    top_p: ovTopP != null ? Number(ovTopP) : Number(TOP_P)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const usage = completion.usage ?? { prompt_tokens: 0, completion_tokens: 0, total_tokens: 0 };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                let recomendaciones: string[] = [];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const content = completion.choices[0].message?.content;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const parsed = JSON.parse(content || '{}');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      recomendaciones = Array.isArray(parsed.recomendaciones) ? parsed.recomendaciones : [];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          } catch (e) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                console.error('‚ùå Error al parsear JSON de OpenAI:', e);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ConversationMemoryManager.saveInteraction(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              userId,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    message,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          JSON.stringify({ empresa: nombre, resumen: resumen.resumen, recomendaciones }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                categoria
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    );

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return NextResponse.json({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              empresa: nombre,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    sector,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          resumen: resumen.resumen,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                recomendaciones,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      telemetry: usage
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            } catch (err: any) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                console.error('üí• Error en POST:', err);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return NextResponse.json({ error: 'Error interno del servidor' }, { status: 500 });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      